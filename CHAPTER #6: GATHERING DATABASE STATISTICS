Oracle 19c PERFORMANCE MANAGEMENT AND TUNING:
============================================

CHAPTER #6: GATHERING DATABASE STATISTICS
--------------------------------------------------
====================================
About Gathering Database Statistics:
====================================

A statistical baseline is a collection of statistic rates usually taken over a time period when the system is performing well at an optimal level. Use statistical baselines to diagnose performance problems by comparing statistics captured in a baseline to those captured during a period of poor performance. Number database calls per second is a metric.

Automatic Workload Repository:
------------------------------
it contains Object statistics,Time model statistics , system and session statistics,SQL statements that are producing the highest load on the system, based on criteria such as elapsed time and CPU time,Active Session History (ASH) statistics,ADDM.

Baselines:
----------
A baseline is a set of snapshots from a specific time period that is preserved for comparison with other snapshots when a performance problem occurs.

Fixed Baselines: A fixed baseline corresponds to a fixed, contiguous time period in the past that you specify.

Moving Window Baselines: A moving window baseline corresponds to all AWR data that exists within the AWR retention period. by default is 8 days. If you are planning to use adaptive thresholds, then consider using a larger moving window—such as 30 days—to accurately compute threshold values.

Baseline Templates: Single baseline template to create a baseline for a single contiguous time period in the future. Repeating baseline template to create and drop baselines based on a repeating time schedule.

Adaptive Thresholds:
--------------------
Adaptive thresholds enable you to monitor and detect performance issues, while minimizing administrative overhead. Adaptive thresholds automatically set warning and critical alert thresholds for some system metrics using statistics derived from metric values captured in the moving window baseline.

	Percentage of Maximum Thresholds:The threshold value for percentage of maximum thresholds is computed as a percentage multiple of the maximum value observed for the data in the moving window baseline.

	Significance Level Thresholds:
		High (.95) Only 5 in 100 observations are expected to exceed this value.
 		Very High (.99) Only 1 in 100 observations are expected to exceed this value.
 		Severe (.999) Only 1 in 1,000 observations are expected to exceed this value.
 		Extreme (.9999) Only 1 in 10,000 observations are expected to exceed this value.

===========================================
Managing the Automatic Workload Repository:
===========================================

Enabling the Automatic Workload Repository:
-------------------------------------------
Gathering database statistics using AWR is enabled by default and is controlled by the STATISTICS_LEVEL initialization parameter by setting it to typical, so that in-memory collection of many system statistics—such as segments statistics and memory advisor information can be captured.

Managing Snapshots:
-------------------
By default, Oracle Database generates snapshots once every hour, and retains the statistics in the workload repository for 8 days. Snapshots can be manually created ot dropped.
If Cloud Control is unavailable, then manage snapshots using the DBMS_WORKLOAD_REPOSITORY package in the command-line interface. The DBA role is required to invoke the DBMS_WORKLOAD_REPOSITORY procedures.
To manually create snapshots, use the CREATE_SNAPSHOT procedure. The following example shows a CREATE_SNAPSHOT procedure call.
BEGIN
 DBMS_WORKLOAD_REPOSITORY.CREATE_SNAPSHOT ();
END;
/
To manually drop a range of snapshots, use the DROP_SNAPSHOT_RANGE procedure. The following example shows a DROP_SNAPSHOT_RANGE procedure call.
BEGIN
 DBMS_WORKLOAD_REPOSITORY.DROP_SNAPSHOT_RANGE (low_snap_id => 22,  high_snap_id => 32, dbid => 3310949047);
END;
/
The following example shows how to modify snapshot settings using the DBMS_WORKLOAD_REPOSITORY.MODIFY_SNAPSHOT_SETTINGS procedure:
BEGIN
 DBMS_WORKLOAD_REPOSITORY.MODIFY_SNAPSHOT_SETTINGS( retention => 43200, 
 interval => 30, 
 topnsql => 100, 
 dbid => 3310949047);
END;
/
select * from DBA_HIST_WR_CONTROL;
The snap_interval and retention values are displayed in the format:
+[days] [hours]:[minutes]:[seconds].[nanoseconds] 

Managing Baselines:
-------------------
By default, Oracle Database automatically maintains a system-defined moving window baseline. However, you may want to manually create a fixed baseline that represents the system operating at an optimal level, so you can compare it with other baselines or snapshots captured during periods of poor performance. To create baselines using command-line interface, use the CREATE_BASELINE procedure as shown in the following example:
BEGIN
 DBMS_WORKLOAD_REPOSITORY.CREATE_BASELINE (start_snap_id => 270, 
 end_snap_id => 280, 
 baseline_name => 'peak baseline', 
 dbid => 3310949047, 
 expiration => 30);
END;
/

To drop a baseline using command-line interface, use the DROP_BASELINE procedure as shown in the following example:
BEGIN
 DBMS_WORKLOAD_REPOSITORY.DROP_BASELINE (baseline_name => 'peak baseline',
 cascade => FALSE, 
 dbid => 3310949047);
END;
/

To rename a baseline using command-line interface, use the RENAME_BASELINE procedure. The following example shows a RENAME_BASELINE procedure call.
BEGIN
 DBMS_WORKLOAD_REPOSITORY.RENAME_BASELINE (old_baseline_name => 'peak  baseline', 
 new_baseline_name => 'peak  mondays', 
 dbid => 3310949047);
END;
/

To modify the window size of the default moving window baseline using the command-line interface, use the MODIFY_BASELINE_WINDOW_SIZE procedure as shown in the following example:
BEGIN
 DBMS_WORKLOAD_REPOSITORY.MODIFY_BASELINE_WINDOW_SIZE (window_size => 30, 
 dbid => 3310949047);
END;
/

To display the summary statistics for metric values in a baseline period using the command-line interface, use the SELECT_BASELINE_METRICS function:
DBMS_WORKLOAD_REPOSITORY.SELECT_BASELINE_METRICS (baseline_name IN VARCHAR2,
 dbid IN NUMBER DEFAULT NULL,
 instance_num IN NUMBER DEFAULT NULL)
 RETURN awr_baseline_metric_type_table PIPELINED;

Managing Baseline Templates:
----------------------------
To create a single baseline template using command-line interface, use the CREATE_BASELINE_TEMPLATE procedure as shown in the following example:
BEGIN
 DBMS_WORKLOAD_REPOSITORY.CREATE_BASELINE_TEMPLATE (start_time => '2012-04-02  17:00:00 PST', 
 end_time => '2012-04-02  20:00:00 PST', 
 baseline_name =>  'baseline_120402', 
 template_name =>  'template_120402', 
 expiration => 30, 
 dbid => 3310949047);
END;
/

To drop a baseline template using command-line, use the DROP_BASELINE_TEMPLATE procedure as shown in the following example:
BEGIN
 DBMS_WORKLOAD_REPOSITORY.DROP_BASELINE_TEMPLATE (template_name =>  'template_2012_mondays',
 dbid => 3310949047);
END;
/

Transporting Automatic Workload Repository Data to Another System:
------------------------------------------------------------------
Exporting AWR Data:
...................
1. At the SQL prompt, enter:
	@$ORACLE_HOME/rdbms/admin/awrextr.sql

2. Specify the database from which AWR data needs to be exported:
	Enter value for db_id: 1377863381

3. Specify the number of days for which you want to view all the snapshot IDs:
	Enter value for num_days: 2
	
4. Define the range of snapshots for which AWR data needs to be exported by specifying the beginning and the ending snapshot IDs:
	Enter value for begin_snap: 30
	Enter value for end_snap: 40

5. Specify the directory object pointing to the directory where the export dump file needs to be stored:
	Enter value for directory_name: DATA_PUMP_DIR

6. Specify a name for the export dump file without the file extension. By default, the file extension of .dmp is used.
	Enter value for file_name: awrdata_30_40

Importing AWR Data:
...................
1. At the SQL prompt, enter:
	@$ORACLE_HOME/rdbms/admin/awrload.sql

2. Specify the directory object pointing to the directory where the export dump file is located:
	Enter value for directory_name: DATA_PUMP_DIR

3. Specify the name of the export dump file without the file extension. By default, the file extension of .dmp is used.
	Enter value for file_name: awrdata_30_40
	
4. Specify the name of the staging schema where the AWR data needs to be imported:
	Enter value for schema_name: AWR_STAGE
	
5. Specify the default tablespace for the staging schema:
	Enter value for default_tablespace: SYSAUX

6. Specify the temporary tablespace for the staging schema:
	Enter value for temporary_tablespace: TEMP

7. First the AWR data is imported into the AWR_STAGE schema and then it is transferred to the AWR tables in the SYS schema.

Using Automatic Workload Repository Views:
------------------------------------------
DBA_HIST_ACTIVE_SESS_HISTORY: Displays the history of the contents of the in-memory active session history for recent system activity.
DBA_HIST_BASELINE_DETAILS: Displays details about a specific baseline.
DBA_HIST_CON_SYSTEM_EVENT: Displays historical information about the total waits for an event.
DBA_HIST_IOSTAT_DETAIL: Displays historical I/O statistics aggregated by file type and function.
DBA_HIST_SQL_PLAN: Displays the SQL execution plans.
DBA_HIST_WR_SETTINGS: Displays the settings and metadata of the AWR.
DBA_HIST_PROCESS_WAITTIME: Displays CPU and wait time for a process type.

Managing Automatic Workload Repository in a Multitenant Environment:
--------------------------------------------------------------------
You can generate a CDB-specific AWR report from a CDB root. (awrrpt.sql)
You can generate a PDB-specific AWR report from a PDB.		(awrrpti.sql)
You can generate a PDB-specific AWR report from a CDB root. (awrrpti.sql)

Managing Automatic Workload Repository in Active Data Guard Standby Databases:
------------------------------------------------------------------------------
AWR snapshots for ADG standby databases are called remote snapshots. A database node, called destination, is responsible for storing snapshots that are collected from remote ADG standby database nodes, called sources. 
Each source must have two database links, a destination-to-source database link and a source-to-destination database link. These database links are configured for each source during the ADG deployment. You must manually reconfigure these database links after certain ADG events, such as failovers, switchovers, and addition and removal of hosts, so that the database applications continue functioning properly after these events.

Destination Database Responsibilities:
• Registering sources
• Assigning unique identifier for each source
• Creating database links between destination and sources
• Scheduling and initiating automatic snapshots for sources
• Managing destination workload by coordinating snapshots among sources
• Managing snapshot settings for each source
• Assigning identifiers to newly generated snapshots
• Partitioning the AWR tables
• Storing the performance data in the local AWR
• Purging the AWR data of destination and sources

Source Database Responsibilities:
• Storing its performance data in the local AWR
• Sending its AWR data to the destination
• Responding to service requests from the destination
• Extracting the AWR data from the destination

!! CONFIGURING THE REMOTE MANAGEMENT FRAMEWORK (RMF) !!
The Remote Management Framework (RMF) is an architecture for capturing performance statistics (AWR data) in an Oracle database.

• The SYS$UMF user is the default database user that has all the privileges to access the system-level RMF views and tables. All the AWR related operations in RMF can be performed only by the SYS$UMF user. The SYS$UMF user is locked by default and it must be unlocked before deploying the RMF topology.
• You need to provide password for the SYS$UMF user when creating database links in the RMF topology. If the password for the SYS$UMF user is changed, all the database links in the RMF topology must be recreated.

Setting Up the RMF Topology:
The following are the steps for setting up the RMF topology:
1. Configure database nodes to add to the topology.
2. Create the topology.
3. Register database nodes with the topology.
4. (Optional) Register database links between the nodes in the topology. This configuration is required when a destination becomes unavailable and a candidate destination needs to connect to the remaining nodes in the topology using database links.

The three database nodes T, S0, and S1 are added to the topology Topology_1. Node T is the destination node and nodes S0 and S1 are the source nodes. Node S1 is a candidate destination, that is, when the original destination T is not available, node S1 becomes the new destination. 

Create the following dblinks before creatring the topology:
• DBLINK_T_to_S0: Database link from T to S0.
• DBLINK_T_to_S1: Database link from T to S1.
• DBLINK_S0_to_T: Database link from S0 to T.
• DBLINK_S0_to_S1: Database link from S0 to S1.
• DBLINK_S1_to_T: Database link from S1 to T.
• DBLINK_S1_to_S0: Database link from S1 to S0.

/* Configure the nodes T, S0, and S1 by executing these procedures */
/* Execute this procedure on node T */
	SQL> exec DBMS_UMF.configure_node ('T');

/* Execute this procedure on node S0 */
	SQL> exec DBMS_UMF.configure_node ('S0', 'DBLINK_S0_to_T');
	
/* Execute this procedure on node S1 */
	SQL> exec DBMS_UMF.configure_node ('S1', 'DBLINK_S1_to_T');
	
/* Execute all the following procedures on the destination node T */
/* Create the topology 'Topology_1' */
	SQL> exec DBMS_UMF.create_topology ('Topology_1');
	
/* Register the node S0 with the topology 'Topology_1' */
	SQL> exec DBMS_UMF.register_node ('Topology_1',
									  'S0',
									  'DBLINK_T_to_S0',
									  'DBLINK_S0_to_T',
									  'TRUE' /* Set it as a source */,
									  'FALSE' /* Set it as not a candidate destination */);
 
/* Register the node S1 with the topology 'Topology_1' */
	SQL> exec DBMS_UMF.register_node ('Topology_1',
									  'S1',
									  'DBLINK_T_to_S1',
									  'DBLINK_S1_to_T', 
									  'TRUE' /* Set it as a source */,
									  'TRUE' /* Set it as a candidate destination */);
									
/* Register the database links between the nodes S0 and S1 in the topology 'Topology_1'. 
 * When destination T is unavailable at the time of failover, the source S0 can connect to the candidate destination S1 using this database link. */
 
	SQL> exec DBMS_UMF.create_link ('Topology_1',
									'S0',
									'S1',
									'DBLINK_S0_to_S1',
									'DBLINK_S1_to_S0');
/* Enable the AWR service on the node S0 in the topology 'Topology_1' */
	SQL> exec DBMS_WORKLOAD_REPOSITORY.register_remote_database(node_name=>'S0');

/* Enable the AWR service on the node S1 in the topology 'Topology_1' */
	SQL> exec DBMS_WORKLOAD_REPOSITORY.register_remote_database(node_name=>'S1');
	

Managing ADG Role Transition:
SQL> EXEC DBMS_UMF.CREATE_LINK (topology name, 
								source name, 
								candidate destination name,
								source to candidate destination database link,
								candidate destination to source database link);

Take an AWR snapshot on the candidate destination.

Restart the candidate destination as well as all the sources:
	SQL> EXEC DBMS_UMF.SWITCH_DESTINATION(topology name, force_switch=>FALSE);

=================================================
Generating Automatic Workload Repository Reports:
=================================================
Generating an AWR Report for the Local Database (awrrpt.sql)
Generating an AWR Report for a Specific Database(awrrpti.sql)
Generating an AWR Report for the Local Database in Oracle RAC (awrgrpt.sql) 
Generating an AWR Report for a Specific Database in Oracle RAC (awrgrpti.sql) 
Generating an AWR Report for a SQL Statement on the Local Database (awrsqrpt.sql) 
Generating an AWR Report for a SQL Statement on a Specific Database (awrsqrpi.sql)

=========================================
Generating Performance Hub Active Report:
=========================================
This reports sits between AWR and ADDM report.

About Performance Hub Active Report Types:
Basic: Only the basic information
Typical: SQL Monitor information for the top SQL statements.
All: The SQL Monitor information for all SQL statements contained in the Monitored SQL tab.

To generate a Performance Hub active report:
1. At the SQL prompt, enter:
	@$ORACLE_HOME/rdbms/admin/perfhubrpt.sql
2. Specify the desired report type:
	Please enter report type: typical
3. Enter the value for the database identifier of the database you want to use:
	Please enter database ID: 3309173529
4. Enter the value for the instance number of the database instance you want to use:
	Please enter instance number: all instances
5. Enter the desired time period by specifying an end time and a start time in the format of dd:mm:yyyy hh:mi:ss:
	Please enter end time in format of dd:mm:yyyy hh24:mi:ss: 03:04:2014 17:00:00
	Please enter start time in format of dd:mm:yyyy hh24:mi:ss: 03:04:2014 16:00:00
6. Enter a report name, or accept the default report name:
	Enter value for report_name: my_perfhub_report.html
